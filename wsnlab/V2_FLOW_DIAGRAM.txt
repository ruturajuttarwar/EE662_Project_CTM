╔══════════════════════════════════════════════════════════════════════════════╗
║                    DATA COLLECTION TREE V2 - FLOW DIAGRAM                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ PHASE 1: YELLOW APPEARS & SENDS JOIN REQUEST                                │
└─────────────────────────────────────────────────────────────────────────────┘

    [YELLOW NODE]
         │
         │ Sends PROBE
         ▼
    [ROOT/CH] ──────► Sends HEARTBEAT
         │
         ▼
    [YELLOW] turns yellow (UNREGISTERED)
         │
         │ Sends JOIN_REQUEST (broadcast)
         ▼
    [Multiple GREENS receive it]


┌─────────────────────────────────────────────────────────────────────────────┐
│ PHASE 2: GREENS NOMINATE THEMSELVES                                         │
└─────────────────────────────────────────────────────────────────────────────┘

    [GREEN 1] ──┐
    [GREEN 2] ──┼──► ROUTER_NOMINATION ──► [CH/ROOT]
    [GREEN 3] ──┘                              │
                                               │ Sets: router_promotion_in_progress = True
                                               │       current_yellow_being_promoted = yellow_id
                                               │
                                               │ Collects nominations for 2 seconds
                                               ▼
                                          [TIMER fires]


┌─────────────────────────────────────────────────────────────────────────────┐
│ PHASE 3: CH/ROOT FORWARDS NOMINATIONS TO YELLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

    [CH/ROOT]
         │
         │ ROUTER_NOMINATIONS_LIST (all greens)
         ▼
    [YELLOW]
         │
         │ Calculates distances from neighbors_table
         │ Selects closest green
         │
         │ YELLOW_GREEN_SELECTION
         ▼
    [CH/ROOT]
         │
         │ Starts 3-second timeout timer
         ▼


┌─────────────────────────────────────────────────────────────────────────────┐
│ PHASE 4: CH/ROOT APPROVES SELECTED GREEN                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    [CH/ROOT]
         │
         ├──► ROUTER_APPROVAL ──────► [Selected GREEN]
         │
         └──► ROUTER_REJECTION ─────► [Other GREENs]


┌─────────────────────────────────────────────────────────────────────────────┐
│ PHASE 5: GREEN BECOMES ROUTER, YELLOW BECOMES CH                            │
└─────────────────────────────────────────────────────────────────────────────┘

    [Selected GREEN]
         │
         │ NETWORK_REQUEST (with yellow_id, router_id)
         ▼
    [ROOT]
         │
         │ NETWORK_REPLY (allocates CH address for yellow)
         ▼
    [GREEN] ──────► Becomes ROUTER (orange)
         │
         │ BECOME_CH
         ▼
    [YELLOW] ─────► Becomes CH (blue)
         │
         │ ROUTER_PROMOTION_COMPLETE
         ▼
    [CH/ROOT]
         │
         │ router_promotion_in_progress = False  ← LOCK RELEASED!
         ▼
    Ready for next yellow!


╔══════════════════════════════════════════════════════════════════════════════╗
║                              EDGE CASES                                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

CASE A: Yellow Timeout (3 seconds)
    [YELLOW] doesn't respond
         │
         ▼
    [TIMER_YELLOW_SELECTION_TIMEOUT fires]
         │
         ├──► Release lock
         └──► Send ROUTER_REJECTION to all greens

CASE B: Yellow Joins CH Directly
    [YELLOW] ──► JOIN_ACK ──► [CH]
         │
         ▼
    [CH] broadcasts YELLOW_JOINED_CH
         │
         ▼
    [Promoting CH/ROOT] cancels promotion, releases lock

CASE C: Green No Longer Registered
    [GREEN] receives ROUTER_APPROVAL but is now CH/ROUTER
         │
         │ ROUTER_APPROVAL_FAILED
         ▼
    [CH/ROOT] re-forwards remaining nominations to yellow

CASE D: No Greens Available
    [CH/ROOT] receives 0 nominations
         │
         ▼
    Release lock, yellow will retry and join CH directly
